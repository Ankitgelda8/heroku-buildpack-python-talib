#!/usr/bin/env bash

echo "Starting TA-Lib C library installation..."

# Step 1: Download and unpack the TA-Lib C library source code
echo "Downloading TA-Lib C library..."
wget -q http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz -O ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to download TA-Lib source code"
  exit 1
}

echo "Unpacking TA-Lib C library..."
tar -xf ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to unpack TA-Lib source code"
  exit 1
}
cd ta-lib || {
  echo "Failed to change directory to TA-Lib source"
  exit 1
}

# Step 2: Compile and install the TA-Lib C library
echo "Compiling TA-Lib C library..."
./configure --prefix=/app/.heroku || {
  echo "Configuration failed"
  exit 1
}
make || {
  echo "Compilation failed"
  exit 1
}
echo "Installing TA-Lib C library..."
make install || {
  echo "Installation failed"
  exit 1
}

# Cleanup unnecessary files
echo "Cleaning up TA-Lib C library files..."
cd ..
rm -rf ta-lib ta-lib-0.4.0-src.tar.gz

# Step 3: Install the Python wrapper for TA-Lib
echo "Installing TA-Lib Python wrapper..."
/app/.heroku/python/bin/pip install --no-cache-dir TA-Lib==0.4.24 || {
  echo "Failed to install TA-Lib Python wrapper"
  exit 1
}

echo "TA-Lib installation completed successfully!"
