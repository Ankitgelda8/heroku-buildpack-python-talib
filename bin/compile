#!/usr/bin/env bash

echo "Installing TA-Lib C library and Python wrapper..."

# Step 1: Download and compile the TA-Lib C library
echo "Downloading TA-Lib C library..."
wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz -O ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to download TA-Lib source code"
  exit 1
}

echo "Extracting TA-Lib C library..."
tar -xf ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to extract TA-Lib source code"
  exit 1
}

cd ta-lib || exit
echo "Configuring TA-Lib C library..."
./configure --prefix=/app/.heroku || {
  echo "Failed to configure TA-Lib"
  exit 1
}

echo "Compiling TA-Lib C library..."
make || {
  echo "Failed to compile TA-Lib"
  exit 1
}

echo "Installing TA-Lib C library..."
make install || {
  echo "Failed to install TA-Lib"
  exit 1
}

cd ..
rm -rf ta-lib ta-lib-0.4.0-src.tar.gz

# Step 2: Install Python wrapper for TA-Lib
echo "Installing TA-Lib Python wrapper..."
CFLAGS="-I/app/.heroku/include" LDFLAGS="-L/app/.heroku/lib" /app/.heroku/python/bin/pip install TA-Lib==0.4.24 || {
  echo "Failed to install TA-Lib Python wrapper"
  exit 1
}

echo "TA-Lib installation completed!"
