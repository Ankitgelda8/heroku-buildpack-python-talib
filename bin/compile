#!/usr/bin/env bash

# Reinstall TA-Lib every time the script runs
echo "Starting TA-Lib installation..."

# Install TA-Lib Python wrapper using pip
echo "Installing TA-Lib Python wrapper..."
/app/.heroku/python/bin/pip install --no-cache-dir TA-Lib==0.4.24 || {
  echo "Failed to install TA-Lib Python wrapper via pip"
  exit 1
}

# Download and unpack TA-Lib C library source code
echo "Downloading and unpacking TA-Lib C library..."
wget -q http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz -O ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to download TA-Lib source code"
  exit 1
}
tar -xf ta-lib-0.4.0-src.tar.gz || {
  echo "Failed to unpack TA-Lib source code"
  exit 1
}
cd ta-lib || {
  echo "Failed to change directory to TA-Lib source"
  exit 1
}

# Compile and install TA-Lib C library
echo "Compiling TA-Lib C library..."
./configure --prefix=/app/.heroku || {
  echo "Configuration failed"
  exit 1
}
make || {
  echo "Compilation failed"
  exit 1
}
echo "Installing TA-Lib C library..."
make install || {
  echo "Installation failed"
  exit 1
}

# Cleanup unnecessary files
echo "Cleaning up..."
cd ..
rm -rf ta-lib ta-lib-0.4.0-src.tar.gz

# Reinstall Python wrapper to link with the compiled C library
echo "Re-installing TA-Lib Python wrapper..."
/app/.heroku/python/bin/pip install --no-cache-dir TA-Lib==0.4.24 || {
  echo "Failed to re-install TA-Lib Python wrapper"
  exit 1
}

echo "TA-Lib installation completed successfully!"
